/**
 * @fileoverview Firestore Security Rules for VoltaView Auth.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data. Each user
 * can only access their own data stored under their unique user ID.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, where {userId} is the Firebase Auth UID.
 * - /users/{userId}/esp32_data/{esp32DataId}: Stores ESP32 data for a specific user.
 *
 * Key Security Decisions:
 * - Users can only create, read, update, and delete their own user documents.
 * - Users can only manage their own ESP32 data.
 * - Listing of user documents is denied to prevent enumeration.
 *
 * Denormalization for Authorization:
 * - The 'userId' is present in both the user document path and the esp32_data document,
 *   enabling efficient ownership checks without additional reads.
 *
 * Structural Segregation:
 * - Private user data and associated ESP32 data are stored under the /users/{userId}
 *   path, ensuring clear ownership and preventing unintended public access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the requesting user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the requesting user owns the document.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the requesting user owns the existing document.
     * @param {string} userId The user ID to compare against the resource's data.
     * @return {bool} True if the user is the owner and the document exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    match /users/{userId} {
      /**
       * @description Controls access to user profile documents.
       * @path /users/{userId}
       * @allow (create) User with UID 'user_abc' can create their own profile.
       * @allow (get) User with UID 'user_abc' can read their own profile.
       * @allow (update) User with UID 'user_abc' can update their own profile.
       * @allow (delete) User with UID 'user_abc' can delete their own profile.
       * @deny (create) User with UID 'user_xyz' cannot create a profile for 'user_abc'.
       * @deny (get) User with UID 'user_xyz' cannot read the profile of 'user_abc'.
       * @principle Enforces document ownership for all operations.
       */
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    match /users/{userId}/esp32_data/{esp32DataId} {
      /**
       * @description Controls access to ESP32 data documents for a specific user.
       * @path /users/{userId}/esp32_data/{esp32DataId}
       * @allow (create) User with UID 'user_abc' can create ESP32 data under their profile.
       * @allow (get) User with UID 'user_abc' can read ESP32 data under their profile.
       * @allow (update) User with UID 'user_abc' can update ESP32 data under their profile.
       * @allow (delete) User with UID 'user_abc' can delete ESP32 data under their profile.
       * @deny (create) User with UID 'user_xyz' cannot create ESP32 data for 'user_abc'.
       * @deny (get) User with UID 'user_xyz' cannot read ESP32 data of 'user_abc'.
       * @principle Enforces document ownership for all operations.
       */
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}